name: Automatización de Agentes

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Actualizar pip
      run: pip install --upgrade pip setuptools wheel

    - name: Instalar dependencias
      run: pip install -r requirements.txt

    - name: Ejecutar agente de noticias
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python agente.py

    - name: Ejecutar agente de videos virales
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python agente_videos.py

    - name: Preparar commit y push solo si hay cambios
      run: |
        set -e
        # Configuración de usuario local (no global)
        git config user.name "Agente Gungo"
        git config user.email "actions@github.com"

        # Mostrar estado para depuración
        echo "Estado antes de agregar archivos:"
        git status --porcelain

        # Añadir cambios
        git add .

        # Detectar cambios en el index
        if git diff --cached --quiet; then
          echo "No hay cambios que commitear. Workflow finalizado correctamente."
        else
          # Crear rama con timestamp para evitar colisiones
          BRANCH="borrador-contenido-$(date +%s)"
          git checkout -b "$BRANCH"

          git commit -m "Actualización automática de contenido"
          git push origin "$BRANCH"
          echo "Cambios commiteados y pusheados a $BRANCH"
        fi

